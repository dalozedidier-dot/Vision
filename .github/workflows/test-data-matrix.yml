name: test-data-matrix

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  matrix-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file:
          - test_data/minimal_timeseries.csv
          - test_data/GDPDeflator.csv
          - test_data/CPI.csv
          - test_data/Population.csv
          - test_data/RealGDP.csv
          - test_data/RealPerCapitaGDP.csv
          - test_data/RealExchangeRate.csv
          - test_data/ITU_DH_INT_USER_PT.csv
          - test_data/ITU_DH_ACT_MOB_PER_100.csv
          - test_data/WB_WBL_SG_LAW_INDX.csv
        mode: [mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Smoke one file
        id: run
        shell: bash
        run: |
          set -euo pipefail

          chmod +x tools/run_parallel.sh || true
          chmod +x tools/run_parallel_real.sh || true
          chmod +x tools/smoke_one.py || true

          # smoke_one.py peut afficher des logs: on ne garde que la DERNIERE ligne comme cycle_id
          CYCLE_ID="$(python3 tools/smoke_one.py \
            --file "${{ matrix.file }}" \
            --mode "${{ matrix.mode }}" | tail -n 1 | tr -d '\r')"

          {
            echo "cycle_id<<EOF"
            echo "$CYCLE_ID"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Make safe artifact name
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          SAFE_FILE="${{ matrix.file }}"
          SAFE_FILE="${SAFE_FILE//\//_}"   # / -> _
          SAFE_FILE="${SAFE_FILE// /_}"    # espaces -> _
          echo "SAFE_FILE=$SAFE_FILE" >> "$GITHUB_ENV"

      - name: Rapport Summary (CSV + cycle)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          echo "## Rapport test_data" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Fichier: \`${{ matrix.file }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Mode: \`${{ matrix.mode }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- cycle_id: \`${{ steps.run.outputs.cycle_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import csv
          import re
          from pathlib import Path

          f = Path("${{ matrix.file }}")
          print("### Statistiques CSV (lecture échantillon)")
          if not f.exists():
            print(f"- Statut: fichier introuvable: {f}")
            raise SystemExit(0)

          def read_rows(delim):
            with f.open("r", encoding="utf-8", errors="ignore", newline="") as fp:
              r = csv.reader(fp, delimiter=delim)
              header = next(r, [])
              rows = []
              for i, row in enumerate(r):
                rows.append(row)
                if i >= 199:
                  break
              return header, rows

          header, rows = read_rows(",")
          if len(header) <= 1:
            header2, rows2 = read_rows(";")
            if len(header2) > len(header):
              header, rows = header2, rows2

          ncols = len(header)
          nrows = len(rows)

          na_tokens = {"na", "nan", "null", "none", ""}
          na_count = 0
          cell_count = 0

          years = set()
          year_re = re.compile(r"^(19|20)\\d{2}$")

          for row in rows:
            for c in row:
              cell_count += 1
              v = (c or "").strip()
              if v.lower() in na_tokens:
                na_count += 1
              if year_re.match(v):
                years.add(int(v))

          for h in header:
            hv = (h or "").strip()
            if year_re.match(hv):
              years.add(int(hv))

          print(f"- Colonnes (header): {ncols}")
          print(f"- Lignes échantillon lues: {nrows} (max 200)")
          if cell_count:
            print(f"- NA-like détectés (échantillon): {na_count} / {cell_count}")
          if years:
            print(f"- Années détectées (échantillon): {min(years)}–{max(years)}")
          else:
            print("- Années détectées (échantillon): aucune")
          PY

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Fichiers produits (présence)" >> "$GITHUB_STEP_SUMMARY"
          CYCLE_DIR="unified_cycles/${{ steps.run.outputs.cycle_id }}"
          [ -f "$CYCLE_DIR/unified_manifest.json" ] && echo "- unified_manifest.json: présent" >> "$GITHUB_STEP_SUMMARY" || echo "- unified_manifest.json: absent" >> "$GITHUB_STEP_SUMMARY"
          [ -f "$CYCLE_DIR/systemd/run_manifest.json" ] && echo "- systemd/run_manifest.json: présent" >> "$GITHUB_STEP_SUMMARY" || echo "- systemd/run_manifest.json: absent" >> "$GITHUB_STEP_SUMMARY"
          [ -f "$CYCLE_DIR/sost/run_manifest.json" ] && echo "- sost/run_manifest.json: présent" >> "$GITHUB_STEP_SUMMARY" || echo "- sost/run_manifest.json: absent" >> "$GITHUB_STEP_SUMMARY"
          [ -f "$CYCLE_DIR/phio/phio_manifest.json" ] && echo "- phio/phio_manifest.json: présent" >> "$GITHUB_STEP_SUMMARY" || echo "- phio/phio_manifest.json: absent" >> "$GITHUB_STEP_SUMMARY"

      - name: Show unified manifest
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cat "unified_cycles/${{ steps.run.outputs.cycle_id }}/unified_manifest.json" || true

      # Pack léger mais auto-suffisant: manifest + entrée + rapports clés
      - name: Upload pack (default)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pack-${{ matrix.mode }}-${{ env.SAFE_FILE }}
          retention-days: 7
          path: |
            unified_cycles/${{ steps.run.outputs.cycle_id }}/unified_manifest.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/input/fixture.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/input/raw/**

            unified_cycles/${{ steps.run.outputs.cycle_id }}/phio/phio_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/phio/phio_manifest.json

            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/extraction_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/ddr_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/e_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/run_manifest.json

            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/dd/dd_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/ddr/ddr_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/e/e_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/run_manifest.json

      # Debug: upload complet uniquement en manuel
      - name: Upload full cycle (manual only)
        if: always() && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: full-${{ matrix.mode }}-${{ env.SAFE_FILE }}
          path: unified_cycles/${{ steps.run.outputs.cycle_id }}/
          retention-days: 3
