name: test-data-matrix

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      files_json: ${{ steps.discover.outputs.files_json }}
      limit_label: ${{ steps.discover.outputs.limit_label }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover CSV files in test_data (light on push, full on manual)
        id: discover
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          event = os.environ.get("GITHUB_EVENT_NAME", "")
          # Push/PR: léger. Manuel: plus large.
          max_mb = 50 if event == "workflow_dispatch" else 5
          max_bytes = max_mb * 1024 * 1024

          root = Path("test_data")
          files = []
          skipped_big = 0

          if root.exists():
            for p in sorted(root.rglob("*.csv")):
              try:
                if p.stat().st_size <= max_bytes:
                  files.append(p.as_posix())
                else:
                  skipped_big += 1
              except FileNotFoundError:
                # rare race condition; ignore
                continue

          Path("/tmp/files.json").write_text(
            json.dumps(files, separators=(",", ":")),
            encoding="utf-8"
          )

          summary = []
          summary.append("## Discover")
          summary.append(f"- Mode event: `{event}`")
          summary.append(f"- Limite taille: {max_mb} MB")
          summary.append(f"- CSV sélectionnés: {len(files)}")
          summary.append(f"- CSV ignorés (trop gros): {skipped_big}")
          summary.append("")
          summary.append("### Liste")
          for f in files:
            summary.append(f"- `{f}`")
          Path("/tmp/discover_summary.md").write_text("\n".join(summary) + "\n", encoding="utf-8")
          PY

          cat /tmp/discover_summary.md >> "$GITHUB_STEP_SUMMARY"

          echo "files_json=$(cat /tmp/files.json)" >> "$GITHUB_OUTPUT"
          # petit label utile pour affichage downstream
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "limit_label=50MB" >> "$GITHUB_OUTPUT"
          else
            echo "limit_label=5MB" >> "$GITHUB_OUTPUT"
          fi

  matrix-test:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.discover.outputs.files_json) }}
        mode: [mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Smoke one file
        id: run
        shell: bash
        run: |
          set -euo pipefail

          chmod +x tools/run_parallel.sh || true
          chmod +x tools/run_parallel_real.sh || true
          chmod +x tools/smoke_one.py || true

          CYCLE_ID="$(python3 tools/smoke_one.py \
            --file "${{ matrix.file }}" \
            --mode "${{ matrix.mode }}" | tail -n 1 | tr -d '\r')"

          echo "cycle_id=$CYCLE_ID" >> "$GITHUB_OUTPUT"

      - name: Make safe artifact name
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          SAFE_FILE="${{ matrix.file }}"
          SAFE_FILE="${SAFE_FILE//\//_}"
          SAFE_FILE="${SAFE_FILE// /_}"
          echo "SAFE_FILE=$SAFE_FILE" >> "$GITHUB_ENV"

      - name: Upload pack (default)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pack-${{ matrix.mode }}-${{ needs.discover.outputs.limit_label }}-${{ env.SAFE_FILE }}
          retention-days: 7
          path: |
            unified_cycles/${{ steps.run.outputs.cycle_id }}/unified_manifest.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/input/fixture.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/input/raw/**

            unified_cycles/${{ steps.run.outputs.cycle_id }}/phio/phio_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/phio/phio_manifest.json

            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/extraction_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/ddr_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/e_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/systemd/run_manifest.json

            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/dd/dd_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/ddr/ddr_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/e/e_report.json
            unified_cycles/${{ steps.run.outputs.cycle_id }}/sost/run_manifest.json

      - name: Upload full cycle (manual only)
        if: always() && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: full-${{ matrix.mode }}-${{ needs.discover.outputs.limit_label }}-${{ env.SAFE_FILE }}
          path: unified_cycles/${{ steps.run.outputs.cycle_id }}/
          retention-days: 3
